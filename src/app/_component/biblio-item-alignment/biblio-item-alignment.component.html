<app-nav-bar [loginUser]="loginUser"></app-nav-bar>

<div class="container mt-2">
  <h2>Bibliography Items Alignment</h2>
  <hr />

  <div class="input-group mb-3">
    <input type="url" class="form-control" placeholder="Place your zotero library url..."
      [class.is-invalid]="invalidURL" [(ngModel)]="zoteroURL" (keyup)="checkURL()" />
    <i class="input-group-text bi bi-download fs-4" style="cursor: pointer;" id="basic-addon2" (click)="fetch()"
      *ngIf="!isFetching"></i>
    <div class="input-group-text" *ngIf="isFetching">
      <div class="spinner-border text-primary" role="status">
      </div>
    </div>

    <div *ngIf="invalidURL" [class.invalid-feedback]="invalidURL">
      Please provide a valid zotero URL.
    </div>
  </div>
  <div class="progress" *ngIf="isFetching">
    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75"
      aria-valuemin="0" aria-valuemax="100"
      [style.width.%]="(zoteroAPI.fetchingPercentage / zoteroAPI.otherLibItemsCount) * 100 | number:'1.2-2'">
      {{ (zoteroAPI.fetchingPercentage / zoteroAPI.otherLibItemsCount) * 100 | number:'1.2-2' }}%
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="card float-start me-2" style="width: 53%;" *ngIf="matchedBibliography.length>0">
    <h5 class="card-header">Matched Bibliography Items (Total: {{matchedBibliography.length}})</h5>
    <div class="card-body h-25">
      <div class="table-responsive" style="height: 65vh !important;">
        <table class="table table-striped table-hover">
          <thead class="sticky-top bg-light text-dark">
            <tr>
              <th scope="col" style="width: 50%;" (click)="sortByCol('title', $event)">Title <i
                  class="bi bi-chevron-up  float-end"></i></th>
              <th scope="col" (click)="sortByCol('date', $event)">Date <i class="float-end"></i></th>
              <th scope="col" (click)="sortByCol('creators', $event)">Creator <i class="float-end"></i></th>
            </tr>
          </thead>

          <tbody *ngFor="let data of matchedBibliography; let isEven = even; let isOdd = odd">
            <tr style="cursor: pointer;" [class]="isEven ? 'bg-white' : 'bg-light'">
              <td title="{{data.title}}">
                <p *ngIf="data.title.length < 50">
                  <i [class]="getItemTypeIcon(data.itemType)"></i>
                  {{data.title}}
                </p>
                <p *ngIf="data.title.length >= 50">
                  <i [class]="getItemTypeIcon(data.itemType)"></i>
                  {{data.title | slice:0:50}}...
                </p>
              </td>
              <td>
                {{ data.date }}
              </td>
              <td title="{{data.getCreators()}}">
                <!-- <span *ngFor="let creator of data.creators"> -->
                <span *ngIf="data.getCreators().length < 30">
                  {{ data.getCreators() }}
                </span>
                <span *ngIf="data.getCreators().length >= 30">
                  {{ data.getCreators() | slice:0:30 }}...
                </span>
                <!-- </span> -->
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card float-start" style="width: 45%;" *ngIf="notMatchedBibliography.length>0">
    <h5 class="card-header">Not Matched (Total: {{notMatchedBibliography.length}})</h5>
    <div class="card-body">
      <div class="table-responsive" style="height: 65vh !important;">
        <table class="table table-striped table-hover">
          <thead class="sticky-top bg-light text-dark">
            <tr>
              <th scope="col" style="width: 50%;" (click)="sortByCol('title', $event)">Title <i
                  class="bi bi-chevron-up  float-end"></i></th>
              <th scope="col" (click)="sortByCol('date', $event)">Date <i class="float-end"></i></th>
              <th scope="col" (click)="sortByCol('creators', $event)">Creator <i class="float-end"></i></th>
            </tr>
          </thead>

          <tbody *ngFor="let data of notMatchedBibliography; let isEven = even; let isOdd = odd">
            <tr style="cursor: pointer;" [class]="isEven ? 'bg-white' : 'bg-light'">
              <td title="{{data.title}}">
                <p *ngIf="data.title.length < 40">
                  <i [class]="getItemTypeIcon(data.itemType)"></i>
                  {{data.title}}
                </p>
                <p *ngIf="data.title.length >= 40">
                  <i [class]="getItemTypeIcon(data.itemType)"></i>
                  {{data.title | slice:0:40}}...
                </p>
              </td>
              <td>
                {{ data.date }}
              </td>
              <td title="{{data.getCreators()}}">
                <!-- <span *ngFor="let creator of data.creators"> -->
                <span *ngIf="data.getCreators().length < 30">
                  {{ data.getCreators() }}
                </span>
                <span *ngIf="data.getCreators().length >= 30">
                  {{ data.getCreators() | slice:0:30 }}...
                </span>
                <!-- </span> -->
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <div class="position-fixed top-0 end-0 p-3 mt-5" style="z-index: 11">
    <div id="divError" style="width: auto;" class="toast align-items-center text-white border-0 mt-3" role="alert"
      aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          {{ errorMessage }}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>
</div>